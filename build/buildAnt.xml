<?xml version="1.0"?>
<project name="voiceAppDev" default="build" >

    <target name="build" depends="env, createConfig, buildWithComposer, copyToTarget" />

    <target name="env">
        <tstamp>
            <format property="BUILD_TIME" pattern="yy-MM-dd-hh-mm-ss" locale="ru,RU"/>
        </tstamp>
        <property environment="env"/>
        <property name="src.configTemplate" location="configTemplate/config.php" />
        <property name="trg.dir" location="${www.baseDir}/${www.domainName}/${BUILD_TIME}" />
        <property name="config.target.dir" location="../protected" />

        <echo>***********************************************</echo>
        <echo>Config template location: ${src.configTemplate}</echo>
        <echo>Target dir for built project: ${trg.dir}</echo>
        <echo>Target dir for config file: ${config.target.dir}</echo>
        <echo>Base dir: ${basedir}</echo>
        <echo>PATH from env: ${env.PATH}</echo>
        <echo>***********************************************</echo>

    </target>

    <target name="createConfig">
        <filter token="db.host" value="${db.host}" />
        <filter token="db.name" value="${db.name}" />
        <filter token="db.user" value="${db.user}" />
        <filter token="db.password" value="${db.password}" />

        <filter token="dbUnitTest.host" value="${dbUnitTest.host}" />
        <filter token="dbUnitTest.name" value="${dbUnitTest.name}" />
        <filter token="dbUnitTest.user" value="${dbUnitTest.user}" />
        <filter token="dbUnitTest.password" value="${dbUnitTest.password}" />

        <filter token="lotusDb.host" value="${lotusDb.host}" />
        <filter token="lotusDb.user" value="${lotusDb.user}" />
        <filter token="lotusDb.password" value="${lotusDb.password}" />
        <filter token="lotusDb.name" value="${lotusDb.name}" />

        <filter token="cdrDb.host" value="${cdrDb.host}" />
        <filter token="cdrDb.user" value="${cdrDb.user}" />
        <filter token="cdrDb.password" value="${cdrDb.password}" />
        <filter token="cdrDb.name" value="${cdrDb.name}" />

        <filter token="axl.username" value="${axl.username}" />
        <filter token="axl.password" value="${axl.password}" />

        <filter token="ssh.login" value="${ssh.login}" />
        <filter token="ssh.password" value="${ssh.password}" />

        <copy todir="${config.target.dir}" filtering="true" overwrite="true">
            <fileset file="${src.configTemplate}" />
        </copy>
    </target>

    <target name="buildWithComposer">
        <exec executable="composer" dir="../">
            <env key="PATH" path="${env.PATH}:/usr/local/bin:/usr/local/sbin" />
        </exec>
    </target>

    <target name="copyToTarget">
        <mkdir dir="${trg.dir}" />
        <move todir="${trg.dir}">
            <fileset dir="../">
                <include name="**" />
                <exclude name="**/build/**" />
            </fileset>
        </move>
    </target>

</project>